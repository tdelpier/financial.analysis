---

---


## Revenue Estimate


```{r}

No_FID_Avalible <- 
  FA_Data_District %>% 
  filter(FY == fiscal.year - 1) %>% 
  select(fid.r.total) %>% 
  mutate(no.fid.avalible = ifelse(is.na(fid.r.total), 1, 0)) %>% 
  pull()


```




`r if(No_FID_Avalible == 1 ){paste("The Financial Information Database (FID) did not include the data necessary to generate an MEA budget estimate for this district.")}`


```{r}
if(No_FID_Avalible == 0 ){
  
  FA_Data_District %>%
    filter(FY >= (fiscal.year - 1)) %>%
    select(FY, starts_with("tab."))%>%
    pivot_longer(cols = c(starts_with("tab.")), 
                 names_to = "Rev_Source", 
                 values_to = "y") %>% 
    mutate(time = ifelse(FY == fiscal.year, "current.year", "last.year" )) %>% 
    pivot_wider(id_cols = Rev_Source, 
                names_from = time, 
                values_from = y) %>% 
    mutate(chg = current.year - last.year,
           pct.chg = (chg / last.year) * 100,
           pct.chg = ifelse(is.infinite(pct.chg), NA, pct.chg),
           Rev_Source = 
             case_when(
                        # Local
                        Rev_Source == "tab.rev.local"           ~ "Total Local Revenue",
                        Rev_Source == "tab.rev.local.found"     ~ "Local Foundation Share",
                        Rev_Source == "tab.rev.local.other"     ~ "Local Other",
                        
                        # state
                        Rev_Source == "tab.rev.state"           ~ "Total State Revenue",
                        Rev_Source == "tab.rev.state.found"     ~ "State Foundation Share",
                        Rev_Source == "tab.rev.state.sped"      ~ "Special Education",
                        Rev_Source == "tab.rev.state.31a"       ~ "At-Risk",
                        Rev_Source == "tab.rev.state.41"        ~ "EL / Bilingual",
                        
                            ### New in FY 2024
                        Rev_Source == "tab.rev.state.31aa"      ~ "Mental Health and Safety",
                        Rev_Source == "tab.rev.state.29"        ~ "Enrollment Stabilization", 
                        
                          # need to update these 
                        Rev_Source == "tab.rev.state.27l"       ~ "Educator Compensation", 
                        Rev_Source == "tab.rev.state.147f"      ~ "0.5% Payroll Reimbursement", 
                        Rev_Source == "tab.rev.state.meals"     ~ "School Meals",
                        Rev_Source == "tab.rev.state.22l"       ~ "Transportation",
                        Rev_Source == "tab.rev.state.35j"       ~ "Early Literacy",
  
                        ####
                        
                        
                        Rev_Source == "tab.rev.state.mpsers.uaal" ~ "MPSERS UAAL",
                        # Rev_Source == "tab.rev.state.mpsers.other" ~ "MPSERS Other",
                        Rev_Source == "tab.rev.state.other"     ~ "State Other",
                        
                        # fed 
                        Rev_Source == "tab.rev.fed"             ~ "Total Federal Revenue",
                        Rev_Source == "tab.rev.fed.stim"        ~ "Federal Stimulus",
                        Rev_Source == "tab.rev.fed.other"       ~ "Federal Recurring",
                        
                        # other
                        Rev_Source == "tab.rev.other"           ~ "Other Revenue",
                        Rev_Source == "tab.rev.other.other"     ~ "Other",
                        # Rev_Source == "tab.rev.other.ml.adjustment" ~ "ML Adjustment",
                        
                        # total
                        Rev_Source == "tab.rev.total.xstim.xuaal" ~ "Total less Stimulus and UAAL",
                        Rev_Source == "tab.rev.total.xstim"     ~ "Total less Stimulus",
                        Rev_Source == "tab.rev.total"           ~ "Total Revenue"
                                  )) %>%
    
  
    flextable() %>% 
    bold(i = ~ Rev_Source %in% c("Total Local Revenue", 
                               "Total State Revenue",
                               "Total Federal Revenue",
                               "Other Revenue",
                               "Total less Stimulus and UAAL",
                               "Total less Stimulus",
                               "Total Revenue"), 
         bold = TRUE, 
         part = "body") %>% 
    
    set_header_labels(Rev_Source = "",
                      current.year = paste(fiscal.year, "Estimate"),
                       # = paste(fiscal.year, "Estimate"),
  
                      last.year = paste(fiscal.year - 1, "Audit"),
                      chg = "Change",
                      pct.chg = "% Change") %>% 
    
    colformat_double(j = c("current.year", 
                           "last.year", 
                           "chg"), 
                     big.mark = ",",
                     digits = 0) %>%
    
    line_spacing(space = .75, part = "body") %>%

    
    colformat_double(j = "pct.chg", suffix = "%") %>% 
    padding(i = ~ Rev_Source %in% c(
                               "Total Local Revenue", 
                               "Total State Revenue",
                               "Total Federal Revenue", 
                               "Other Revenue",
                               "Total less Stimulus and UAAL"), padding.top =  20) %>% 

    # flextable::footnote(i = c(9,10), j = 1, 
    #          value = as_paragraph("The new mental health grant (sec 31aa) and safety grant (sec 97) were not included in the January State Aid Financial Status Report. These values are estimated based on the State's budget."),
    #          ref_symbols = c("1"), 
    #          part = "body") %>% 
    flextable_custom_theme()
    

}

```


\newpage



```{r}

FA_Data_District %>%
  ungroup() %>%
  select(FY, tab.rev.total, tab.rev.fed.stim, 
         tab.rev.state.mpsers.uaal, tab.rev.total.xstim.xuaal) %>%
  mutate(FY = ifelse(FY == fiscal.year, paste0(FY, " est."), FY)) %>% 
  flextable() %>% 
  set_header_labels(FY = "Fiscal Year", 
                    tab.rev.total = "Total Revenue", 
                    tab.rev.total.xstim.xuaal = "Total less Stimulus and UAAL",
                    tab.rev.fed.stim = "Federal Stimulus",
                    tab.rev.state.mpsers.uaal = "UAAL Payment (147c)"
                    ) %>% 
  colformat_double(j = c("tab.rev.total", "tab.rev.total.xstim.xuaal", 
                         "tab.rev.fed.stim", "tab.rev.state.mpsers.uaal"), 
                    big.mark = ",", digits = 0) %>%
  bg(j = "tab.rev.total.xstim.xuaal", bg = "#C2FFDF", part = "all") %>% 
  bg(j = "tab.rev.total", bg = "#d1e8fa", part = "all") %>% 

  flextable_custom_theme()


```


Note: "Revenue Less Stimulus and UAAL" is the preferred measure to fill out MEA's Cost Alignment Calculator (CAC). These dollars represent revenues that are not one-time federal stimulus nor 147c payments that must by law be submitted to the Office of Retirement Services (ORS). 


```{r}

FA_Data_District %>% 
  select(FY, tab.rev.total, tab.rev.total.xstim.xuaal) %>% 
  pivot_longer(cols = c(tab.rev.total, tab.rev.total.xstim.xuaal)) %>% 
  filter(!is.na(value)) %>%
  mutate(name = case_when(name == "tab.rev.total"  ~ "Total Revenue",
                            name == "tab.rev.total.xstim.xuaal" ~ "Revenue less Stimuls and UAAL")) %>% 
 
  ggplot(aes(x = FY, y = value, 
             group = name,  color = name, linetype = name))+
  geom_rect(xmin = 2023, xmax = 2024, 
            ymin = -Inf, 
            ymax = max(FA_Data_District$tab.rev.total) * 1.025, color = NA, 
            fill = mea_gray, alpha = .01)+
  coord_cartesian(clip = 'off')+
  annotate("text", 
         label = "Estimate",
         x = fiscal.year - 0.5,
         y = max(FA_Data_District$tab.rev.total) * 1.05,
         alpha = .75) +
  geom_line(size = line_size, fill = NA) +
  expand_limits(x = fiscal.year + 0.5  )+
  scale_x_continuous(breaks = seq(1990, 2100, by = 1) )+
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  labs(title = "<span style='color: #003057'> Total Revenue</span> and <span style='color: #00A651'> Revenue less Stimuls and UAAL</span>",
       x = "Fiscal Year",
       y = "")+
  scale_color_manual(values = c(mea_green, mea_blue)) +
  scale_fill_manual(values = c(mea_green, mea_blue)) +
  scale_linetype_manual(values=c("solid", "twodash"))+
  theme(legend.box.background = element_rect(color= mea_gray, size=1),
        legend.title = element_blank(),
        legend.position = "bottom",
        plot.title = element_markdown(),
        legend.box = )

```










