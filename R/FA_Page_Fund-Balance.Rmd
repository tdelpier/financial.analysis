------------------------------------------------------------------------

------------------------------------------------------------------------

## Fund Balance

```{r}


FA_Data_District %>%
  ungroup() %>% 
  filter(FY != fiscal.year) %>% 
  select(FY, fid.b.fb.11, fid.b.fb.11.chg, fid.b.fb.11.pct.chg, fid.b.fb.11.pct.rev, fid.b.fb.11.pct.exp) %>%  
  flextable() %>% 
  set_header_labels(FY = "Fiscal Year",
                  fid.b.fb.11 = "Amount",
                  fid.b.fb.11.chg = "Change",
                  fid.b.fb.11.pct.chg = "% Change",
                  fid.b.fb.11.pct.rev = "% of Revenue",
                  fid.b.fb.11.pct.exp = "% of Expenditure") %>% 
  colformat_num(j = "FY",
                big.mark = "") %>%
  colformat_double(j = c("fid.b.fb.11", 
                         "fid.b.fb.11.chg"), 
                   big.mark = ",",
                   digits = 0) %>%
  colformat_double(j = c("fid.b.fb.11.pct.chg", 
                         "fid.b.fb.11.pct.rev", 
                         "fid.b.fb.11.pct.exp"), 
                   suffix = "%") %>% 
  bg(j = "fid.b.fb.11.pct.exp", bg = mea_gray_light , part = "all") %>% 
  flextable_custom_theme(title = "Table x. General Fund Balance")
 

```

```{r}

# max_fb <- FA_Data_District %>% mutate(x = (fid.b.fb.11.pct.exp / 100)+ .03) %>% pull()

FA_Data_District %>% 
  ggplot(aes(x = FY)) + 
  geom_line(aes(y = fid.b.fb.11.pct.exp / 100), size = line_size, color = mea_gray) +
  # geom_line(aes(y = fid.b.fb.11), color = mea_red)+
  geom_hline(yintercept = .05, lty = 2) +
  geom_hline(yintercept = 0) +

  scale_x_continuous(breaks = seq(1990, 2100, by = 1) )+
  scale_y_continuous(labels = percent_format(), 
                     # limits = c(0, max_fb)
                     )+
  labs(title = "Figure xx. General Fund Balance % Expenditure",
       x = "Fiscal Year",
       y = "") 

```

\newpage

### Fund Balance Class

Fund balances can be broken down into five classes based on the type and source of restriction. From most to least limited, those classes are nonspendable, restricted, committed, assigned, and unassigned. Nonspendable assets are those not available for spending such as pre-paid expenditures. Restricted amounts are legally limited by an external body such as the state or federal governments. Restricted resources include state categorical funding, federal grants, as well as sinking funds and bonded capital debt. Committed assets are those constrained by the school district itself using the highest level of decision making authority (a school board resolution). Assigned assets are those intended to be used for a specific purpose and is typically determined by the district's finance committee or an official authorized by the school board. Unassigned assets are all remaining resources after nonspendable, restricted, committed, and assigned.

Committed and assigned assets can be un-committed or un-assigned in the same manner they were originally initiated. While nonspendable and restricted fund balance classes are unalterable by the school district, committed and assigned can be reclassified as unassigned.

```{r}

## General fund balance by class
FA_Data_District %>% 
  filter(FY <= fiscal.year - 1) %>% 
  # select(FY, ends_with(c("assigned", "nonspendable", "unassigned", "restricted", "committed"))) 
  select(FY, fid.b.fb.11.unassigned, fid.b.fb.11.assigned, fid.b.fb.11.committed, 
         fid.b.fb.11.restricted, fid.b.fb.11.nonspendable, fid.b.fb.11) %>% 
  flextable() %>% 
  set_header_labels(FY = "Fiscal Year",
                    fid.b.fb.11.unassigned = "Unassigned",
                    fid.b.fb.11.assigned = "Assigned",
                    fid.b.fb.11.committed = "Committed",
                    fid.b.fb.11.restricted = "Restricted",
                    fid.b.fb.11.nonspendable = "Nonspendable",
                    fid.b.fb.11 = "Total") %>% 
  colformat_double(big.mark = ",",
                   digits = 0) %>% 
    colformat_num(j = "FY",
                big.mark = "") %>%
  flextable_custom_theme(title = "Table x. General Fund Balance by Balance Class")

```

\newpage

### Other Fund Balances

While the General Fund typically contains most resources used on district operations, other funds provide financial transparency for food service, capital financing, and other auxiliary services.

```{r}

FA_Data_District %>% 
  filter(FY <= fiscal.year - 1) %>% 
  select(FY,starts_with("fid.b.fb."),
         -ends_with(c("pct", "exp", "chg", "rev",
                      "assigned", "nonspendable", "unassigned", "restricted", "committed")),
         -fid.b.fb.11) %>%
  select(where(~sum(.) != 0)) %>% 
  rename(any_of(recode_vec)) %>% 
  rename("Fiscal Year" = FY) %>% 
  
  flextable() %>% 
  colformat_double(big.mark = ",",
                   digits = 0) %>% 
  colformat_num(j = "Fiscal Year",
                big.mark = "") %>% 
  flextable_custom_theme(title = "Table x. Other Fund Balancesv by Fiscal Year")



  

```

```{r}

columns_to_select <- c("Unassigned", "Assigned", "Committed", "Restricted", "Nonspendable")

add_missing_cols <- function(data, cols) {
  missing_cols <- cols[!cols %in% names(data)]
  if (length(missing_cols) > 0) {
    for (col in missing_cols) {
      data[[col]] <- 0
    }
  }
  return(data)
}


FA_Data_District %>% 
  filter(FY == fiscal.year - 1) %>% 
  select(starts_with("fid.b.fb.")) %>% 
  select(ends_with(c("assigned", "nonspendable", "unassigned", "restricted", "committed"))) %>% 
  pivot_longer(cols = everything()) %>% 
  mutate(fund = str_sub(name, 10, 11) %>% as.numeric(),
         "Fund Balance Class" = str_remove(name, str_sub(name, 1, 12)) %>% toTitleCase(),) %>% 
  left_join(fund_names, by = join_by(fund)) %>%
  select(value, "Fund Balance Class", fund.name) %>% 
  filter(value != 0) %>% 
  pivot_wider(id_cols = fund.name , 
              values_from = value, 
              names_from = "Fund Balance Class",
              values_fill = 0) %>% 
  add_missing_cols(columns_to_select) %>% 
  select(fund.name, Unassigned, Assigned, Committed, Restricted, Nonspendable) %>% 
  flextable() %>% 


  # add_header_lines(values = paste0("Other Fund Balances by Balance Class, FY ", 
  #                                  fiscal.year-1)) %>% 

  set_header_labels(fund.name = "Fund Name") %>% 
  colformat_double(big.mark = ",",
                   digits = 0) %>% 
  flextable_custom_theme(title = paste0("Table x. Other Fund Balances by Balance Class, FY ", 
                                   fiscal.year-1))


```

Notes:

-   non-General funds names may not match the audit. While district's have flexibility in fund naming internally, fund names are standardized for state reporting.
-   Districts with multiple funds of the same kind are combined in this report. For more detail, refer to the audit.
-   School district classification of non-General fund balances may be inaccurate. Occasionally, school districts will classify revenue from a bonded capital project or other restricted revenue source as assigned or committed.

```{r}
# 
# FA_Data_District %>% 
#   filter(FY == fiscal.year - 1) %>% 
#   ungroup() %>% 
#   fa_helper_fa_data_to_transfer_data() %>% view()
# 
# 
# 
#  
#   ungroup() %>% 
#   select(fund.name.trans.to, fund.balance.restricted, fund.balance.unrestricted, fund.balance) %>% 
#   flextable() %>% 
#   add_header_lines(values = "Fund Balances") %>% 
#   set_header_labels(fund.name.trans.to = "Fund",
#                     fund.balance.restricted = "Restricted",
#                     fund.balance.unrestricted = "Unrestricted",
#                     fund.balance = "Total") %>% 
#   colformat_double(j = c("fund.balance.restricted", 
#                          "fund.balance.unrestricted",
#                          "fund.balance"), 
#                    big.mark = ",",
#                    digits = 0) %>%
# 
#   flextable_custom_theme()


```
